<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Página</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"
        integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>

    <header>

        <div class="container-bg no-select">
            <img draggable="false" class="landscape" src="assets/images/flat-design-mountain-landscape/fondo.png"
                alt="">
            <img draggable="false" class="landscape" src="assets/images/flat-design-mountain-landscape/piso_1.png"
                alt="">
            <img draggable="false" class="landscape" src="assets/images/flat-design-mountain-landscape/piso_2.png"
                alt="">
            <img draggable="false" class="landscape" src="assets/images/flat-design-mountain-landscape/piso_3.png"
                alt="">
            <img draggable="false" class="landscape" src="assets/images/flat-design-mountain-landscape/piso_4.png"
                alt="">
            <img draggable="false" class="landscape" src="assets/images/flat-design-mountain-landscape/piso_5.png"
                alt="">
            <img draggable="false" class="landscape" src="assets/images/flat-design-mountain-landscape/piso_6.png"
                alt="">
            <img draggable="false" class="back" src="assets/images/flat-design-mountain-landscape/fondoizq.png" alt="">
            <img draggable="false" class="back" src="assets/images/flat-design-mountain-landscape/fondoder.png" alt="">
            <img draggable="false" class="moon " src="assets/images/flat-design-mountain-landscape/luna.png" alt="">
            <img draggable="false" class="birds" src="assets/images/flat-design-mountain-landscape/aves.png" alt="">

            <h1>Parallax Wallpaper</h1>
        </div>



    </header>


    <main tabindex="1">
        <div class="accordion">
            <i class="fa-solid fa-caret-left"></i>
        </div>
        <div class="container-text">
            <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Voluptatum quasi nam accusantium minima error
                ratione aliquid ullam ab. Perspiciatis quae harum molestias nam mollitia rem iure illum id sunt
                officiis?
                Ad, perferendis numquam error omnis quis nam optio iure dolor aliquid asperiores iste minima amet, esse
                maiores reiciendis labore maxime? Tempora rerum quis error accusamus, ea laborum quisquam distinctio
                atque?
                Dolor, dicta dolorem facilis, nam ducimus consequatur ea perspiciatis eveniet magni asperiores sequi
                eaque rem corrupti temporibus repellat odit, maxime quam? Eius, ad adipisci! In error voluptatum nobis
                maxime sunt!
                Aliquam minus necessitatibus quam ipsa aliquid recusandae, blanditiis ipsam! Consequatur perspiciatis
                facilis nam iusto possimus, sint vero, ab impedit omnis ut consectetur doloremque, incidunt animi ipsa
                numquam tempore unde itaque.
                Quasi consectetur ipsam, optio dolores aut delectus? Laborum dolore accusamus saepe quibusdam mollitia
                beatae iusto ab excepturi, distinctio minima rerum voluptatem nam atque porro vitae repellat nemo sint
                ipsam temporibus?
                Tenetur moat eum unde vel corrupti. Saepe rerum nobis cupiditate assumenda quidem possimus nam quisquam
                perferendis odio atque itaque nemo obcaecati natus pariatur rem unde, fuga amet!
                Impedit, doloremque. Expedita commodi ducimus suscipit eos eum architecto iusto eligendi autem molestias
                quia, sequi saepe impedit est voluptatum enim ipsa nihil ad quisquam porro natus aliquid? Reiciendis,
                laboriosam voluptatum.
                Itaque fuga repellendus consequuntur tempore quasi illo eum molestias vitae omnis, quas, a ratione
                veritatis dolores deleniti! Deleniti debitis voluptate dolores ipsam in neque ut asperiores, natus quam
                pariatur officia!
                Praesentium quas hic inventore unde veritatis maxime doloribus, ipsa illo quisquam, qui natus maiores
                quidem rem vero impedit incidunt. Esse unde incidunt suscipit facilis laboriosam perferendis eos
                blanditiis inventore hic?
                Mollitia porro earum sequi dolore quos illum est a quas ex? Unde fuga perspiciatis praesentium
                consectetur aut magnam mollitia libero, vitae id delectus! Modi atque accusantium odio fugiat nemo
                debitis.
                Facere, consequuntur tenetur necessitatibus corporis ea perferendis optio. Nisi distinctio magni quidem
                quam ut. Illum quasi eos iure natus debitis, quibusdam, quaerat ullam vero, officia molestconsectetur
                rem, eaque accusamus iste libero tempore perferendis eum, commodi fuga?
                Lorem ipsum, dolor sit amet consectetur adipisicing elit. Provident facere molestiae itaque dolorem, ad
                voluptatum dolores illo blanditiis voluptate nisi. Eius, sed maiores, sapiente sint, rerum ipsum
                consectetur at officiis aspernatur accusamus nesciunt. Aut ipsum quia similique assumenda voluptate iure
                nulla corporis possimus in eveniet. Commodi, ratione maxime delectus odit veniam laudantium culpa esse
                quasi est asperiores consequatur ea itaque fuga, recusandae, laborum in sed autem natus fugit hic
                sapiente. A magni adipisci quasi sit officiis ipsam, impedit tempore dolorum, numquam pariatur
                consectetur possimus, sequi eius. Non, atque laudantium. Fugit assumenda harum vitae nemo accusamus
                voluptatibus? Repellendus, quia nesciunt minus omnis rem deserunt adipisci perspiciatis porro similique
                quaerat quos! Vitae commodi itaque quia ducimus eos corrupti magnam, dignissimos consequuntur asperiores
                enim cupiditate unde quam eius cumque voluptas esse explicabo tenetur? Perspiciatis saepe libero aliquid
                qui aperiam voluptas vitae doloribus maxime deserunt cupiditate beatae possimus eum, a sequi tempore
                nesciunt ratione animi sed pariatur commodi ab numquam velit. Perferendis cum, aut deleniti debitis at
                itaque eveniet dolor fuga voluptate. Molestiae sit ipsam doloremque molestias. Soluta est, ex voluptates
                ea quos tempora molestiae voluptatibus vel. Saepe a sapiente, corporis rem, praesentium esse consequatur
                nemo deleniti vitae pariatur quae dolores aspernatur! Accusantium, voluptatum!</p>

            <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Tempore animi eveniet voluptatem delectus
                assumenda eligendi? Exercitationem asperiores a quisquam, perspiciatis sed quibusdam cupiditate nobis
                quaerat illo reiciendis impedit tempore obcaecati?</p>
        </div>

        <!-- <div class="scroll-container">
            <div class="arrow up"><i class="fa-solid fa-caret-up"></i></div>
            <div class="scroll">
                <div class="thumb"></div>
            </div>
            <div class="arrow down"><i class="fa-solid fa-caret-down"></i></div>
        </div> -->
    </main>




    <script>

        let textContainter = document.querySelector('main .container-text')


        if (isScrolleable(textContainter)) {
            createScroll(textContainter)

            addEventsTextScroll()
            addEventsParallax()
        }


        function isScrolleable(element) {

            if (element.offsetHeight < element.scrollHeight) {

                return true
            }
            return false
        }

        function createScroll(element) {

            let scrollContainer = document.createElement('DIV')
            scrollContainer.classList.add('scroll-container')

            let arrowUp = document.createElement('DIV')
            arrowUp.classList.add('arrow', 'up')

            let iconUp = document.createElement('I')
            iconUp.classList.add('fa-solid', 'fa-caret-up')

            let scroll = document.createElement('DIV')
            scroll.classList.add('scroll', 'no-select')
            scroll.setAttribute('draggable', 'false')

            let thumb = document.createElement('DIV')
            thumb.classList.add('thumb', 'no-select')
            thumb.setAttribute('draggable', 'false')

            let arrowDown = document.createElement('DIV')
            arrowDown.classList.add('arrow', 'down')

            let iconDown = document.createElement('I')
            iconDown.classList.add('fa-solid', 'fa-caret-down')


            arrowUp.append(iconUp)
            arrowDown.append(iconDown)
            scroll.append(thumb)


            scrollContainer.append(arrowUp)
            scrollContainer.append(scroll)
            scrollContainer.append(arrowDown)

            element.after(scrollContainer)

        }



        function addEventsTextScroll() {
            let textParraph = textContainter.querySelector('p')

            let thumb = document.querySelector('.scroll-container .scroll .thumb')

            let heightThumb = null

            let btnDown = document.querySelector('main .arrow.down')

            let slideInterval = null, scrollTextInterval = null

            let accordionBtn = document.querySelector('main .accordion')

            updateSizeThumb()


            document.body.addEventListener('pointerdown', slideBtn)
            document.body.addEventListener('wheel', slideScroll)
            addEventListener('resize', updateSizeThumb)//actualiza el tamaño del thumb scroll cuando se cambia de tamaño
            document.body.addEventListener('pointerup', stopSlide)// Quita el setInterval del scroll
            document.addEventListener('dragover', e => e.preventDefault())


            accordionBtn.addEventListener('pointerdown', accordion)


            // console.log(textContainter.scrollHeight);

            // console.log(textContainter.offsetHeight);

            function accordion(event) {

                // fa-solid fa-caret-left
                let parent =  document.querySelector('main')
                let arrow
                if(event.target.classList.contains('fa-caret-left')) {
                    parent.style.transform = `translateX(-95%)`
                    
                    
                    arrow = document.createElement('I')
                    arrow.classList.add('fa-solid','fa-caret-right')
                    arrow.style.transform =  `translateX(${parent.offsetWidth*0.9}px)`


                   

                    event.target.parentElement.append(arrow)
                    event.target.remove()
                }else
                if(event.target.classList.contains('fa-caret-right')) {
                    parent.style.transform = `translateX(1%)`
                    arrow = document.createElement('I')
                    arrow.classList.add('fa-solid','fa-caret-left')
                    arrow.style.transform =  `translateX(-${parent.offsetWidth*0.001}px)`
                    event.target.parentElement.append(arrow)
                    event.target.remove()
                }

                
            }


            function slideBtn(event) {

                if (event.target) {


                    // slide con teclas flecha arriba/abajo
                    if (event.target.closest('main .container-text') || event.target.closest('.scroll-container .scroll')) {

                        lastSelection = event.target.closest('main .container-text')

                        document.body.addEventListener('keydown', pressKey)

                        document.body.addEventListener('keyup', stopSlide)
                    } else {
                        // Si el target o focus no está dentro del text container no se scroleara con las flechas
                        document.body.removeEventListener('keydown', pressKey)


                    }



                    if (event.target.closest('div.arrow.down')) {

                        slide(true)

                    } else
                        if (event.target.closest('div.arrow.up')) {

                            slide(false)
                        }
                        // cuando se hace click encima de la barra
                        else
                            if (event.target.closest('.scroll-container .scroll')) {

                                let target = event.target.closest('.scroll-container .scroll .thumb')

                                // ya que el desplazamiento es solo vertical no re quiere la posX
                                let posYInicial


                                if (!target) {

                                    target = event.target.closest('.scroll-container .scroll')
                                    posYInicial = event.clientY - target.getBoundingClientRect().top

                                    //target => scroll
                                    centrar(event.clientY, target)
                                    scrollText(target)


                                    // target.querySelector('.thumb').click()

                                } else {

                                    posYInicial = event.clientY - target.getBoundingClientRect().top

                                    // target => thumb
                                    document.addEventListener('pointermove', moveCB)


                                    document.addEventListener('pointerup', () => {
                                        document.removeEventListener('pointermove', moveCB)
                                    })
                                }


                                function moveCB(event) {

                                    textContainter.classList.add('no-select')

                                    move(event.clientY, target)
                                    scrollText(target.parentElement, false) // thumb => parentElement => scroll
                                }


                                function scrollText(scroll, boolean = true) {

                                    let thumb = scroll.querySelector('.thumb')

                                    let thumbCoords = thumb.getBoundingClientRect()
                                    let scrollCoords = scroll.getBoundingClientRect()

                                    let scrollInterval = null, invMultiply = null
                                    let movement

                                    if (boolean) movement = 'smooth'
                                    else movement = 'auto'

                                    // thumbCoords.top -scrollCoords.top)*100/ scroll.offsetHeight => distancia coordenada superior ventana hacia thumb - distancia coordenada superior ventana hacia borde superior de scroll 

                                    // esto devuelve medida en pixeles del top de thumb, para convertirlo en % => multiplicar por 100 y dividir por el alto del scroll 

                                    height = ((thumbCoords.top - scrollCoords.top) * 100 / scroll.offsetHeight) * textContainter.scrollHeight / 100

                                    // console.log(height);
                                    textContainter.scrollTo({
                                        top: height,
                                        left: 0,
                                        behavior: movement
                                    })
                                }


                                function centrar(clientY, scroll) {

                                    // Si se ha realizado click en el scroll pero no en thumb

                                    // console.log(clientY);

                                    let thumbScroll = scroll.querySelector('.thumb')

                                    // console.log(((posYInicial - thumbScroll.offsetHeight/2 )* 100 / scroll.scrollHeight ));


                                    let top = ((posYInicial - thumbScroll.offsetHeight / 2) * 100 / scroll.scrollHeight)

                                    let bottomScroll = scroll.getBoundingClientRect().bottom

                                    if (top < 0) {
                                        top = 0;
                                    }

                                    if (clientY + thumbScroll.offsetHeight / 2 > bottomScroll) {
                                        top = (scroll.offsetHeight - thumbScroll.offsetHeight) * 100 / scroll.scrollHeight
                                    }


                                    thumbScroll.style.top = top + '%';

                                }


                                function move(clientY, thumb) {


                                    let scrollCoords = thumb.parentElement.getBoundingClientRect()

                                    let top = (clientY - posYInicial - scrollCoords.top) * 100 / scrollCoords.height

                                    if (top < 0) {
                                        top = 0
                                    }

                                    let bottom = scrollCoords.height - thumb.offsetHeight

                                    if (top / 100 * scrollCoords.height > bottom) {
                                        console.log("entra aca");
                                        top = bottom * 100 / scrollCoords.height
                                    }

                                    thumb.style.top = top + '%'

                                }



                            }

                            // para dispositivos touch
                            else if (event.pointerType == 'touch') {

                                if (event.target.closest('main .container-text')) {

                                    event.target.addEventListener('pointermove', (e) => {

                                        textContainter.scrollBy({
                                            top: -e.movementY * 20,
                                            left: 0,
                                            behavior: "smooth"
                                        })
                                        updatePosThumb()
                                    })

                                }

                            }


                }

            }




            function pressKey(event) {

                if (event.key == 'ArrowUp') {
                    slide(false)
                } else
                    if (event.key == 'ArrowDown') {
                        slide(true)
                    } return

            }



            function scrollTextThumb(boolean) {
                let invMultiply

                if (boolean) invMultiply = 1
                else invMultiply = -1

                scrollTextInterval = setInterval(() => {
                    textContainter.scrollTop += 10 * invMultiply


                    if (invMultiply < 0 && textContainter.scrollTop == 0) {
                        clearInterval(scrollTextInterval)
                        scrollTextInterval = null
                    } else
                        if (invMultiply > 0 && (textContainter.scrollTop + textContainter.offsetHeight == textContainter.scrollHeight)) {
                            clearInterval(scrollTextInterval)
                            scrollTextInterval = null
                        }


                }, 5)

            }





            // desplaza el text container
            function slide(boolean) {

                let invMultiply
                if (boolean) invMultiply = 1
                else invMultiply = -1

                if (!slideInterval) {
                    slideInterval = setInterval(() => {
                        textContainter.scrollTop += 10 * invMultiply
                        updatePosThumb()
                    }, 40);
                }

            }



            // callback de event wheel (desplaza texto con la rueda de mouse)
            function slideScroll(event) {



                if (scrollTextInterval) {
                    console.log("eliminar");
                    clearInterval(scrollTextInterval)
                    scrollTextInterval = null

                }

                // console.log("scroll ruedad");



                // deltaY es - si sube y + si baja
                if (event.deltaY && (event.target.closest('main .container-text') || event.target.closest('.scroll-container .scroll'))) {
                    textContainter.scrollTop += event.deltaY / 5
                    updatePosThumb()
                }

            }


            // detiene intervalo de desplazamineto de container text
            function stopSlide(event) {

                textContainter.classList.remove('no-select')
                clearInterval(slideInterval)
                slideInterval = null

            }


            // callback de event resize => actualiza el tamaño del thumb
            function updateSizeThumb() {

                heightThumb = (textContainter.offsetHeight * 100 / textContainter.scrollHeight) * 4.8

                thumb.style.setProperty('--height', heightThumb + 'px')

            }

            // actualiza la posicion del thumb de scroll
            function updatePosThumb() {

                thumb.style.top = textContainter.scrollTop * 100 / textContainter.scrollHeight + '%'
            }







        }



        function addEventsParallax() {



            textContainter.addEventListener('scroll', parallax)

            let containerImgs = document.querySelector('header .container-bg')
            let elParallax = Array.from(document.querySelectorAll('header .container-bg img'))
            let thumb = textContainter.nextElementSibling.querySelector('.thumb')


            elParallax.push(containerImgs.querySelector('h1'))


            function parallax(event) {

                let topScroll = parseInt(getComputedStyle(thumb).top) //devuelve medida en pixeles
                topScroll = parseFloat(thumb.style.top) // obtener el % , parse float para guardar los dec

                // console.log(topScroll);

                elParallax.forEach((el, index) => {

                    if (index != 0) {

                        let translateX = topScroll * (el.offsetWidth - containerImgs.offsetWidth) / 100



                        if (index % 2 == 0) {
                            translateX = -translateX
                        }

                        index += 5

                        if (el.classList.contains('landscape') || el.tagName == 'H1') {

                            // console.log(img.offsetWidth - containerImgs.offsetWidth);

                            if (el.tagName == 'H1') translateX = -translateX



                            // console.log(translateX);
                            // console.log(-translateX);
                            el.style.transform = `translateX(${-translateX - 50 / index}px)`

                        }

                        if (el.classList.contains('birds')) {

                            // console.log(translateX/100);

                            el.style.transform = `translate(${-translateX - 50 / index}px, ${translateX / 10}%) `
                        }
                    }
                })


                let moon = containerImgs.querySelector('.moon')
                let bg = containerImgs.querySelector(':first-child')

                let thumbCoords = thumb.getBoundingClientRect()
                let scrollCoords = thumb.parentElement.getBoundingClientRect()



                console.log(thumbCoords.bottom);
                console.log(scrollCoords.bottom);

                let bottom = (scrollCoords.height - thumb.offsetHeight) * 100 / scrollCoords.height


                if(parseInt(thumb.style.top) > bottom - 5) {
                    moon.classList.add('active-moon')
                    bg.classList.add('bg-night')
                }else {
                    moon.classList.remove('active-moon')
                    bg.classList.remove('bg-night')
                }
                
            }







        }




        



    </script>



</body>

</html>